name: Build OpenSSL for Windows
on:
  workflow_dispatch:
    inputs:
      sslrel:
        description: "OpenSSL version to build (Tarball Link)"
        required: true
        default: 'https://github.com/openssl/openssl/releases/download/openssl-3.5.2/openssl-3.5.2.tar.gz'
      nasmurl:
        description: "NASM zip link"
        required: true
        default: 'https://nasm.us/pub/nasm/releasebuilds/2.16.03/win64/nasm-2.16.03-win64.zip'
      osslver:
        description: "OpenSSL Version (Should be the same as the one specified in link else build will fail!)"
        required: true
        default: '3.5.2'

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Output OpenSSL path
        id: osslout
        shell: cmd
        run: echo sslp="%userprofile%\OpenSSL">>"%GITHUB_OUTPUT%"
      - name: Install Deps
        shell: cmd
        run: |
              md "%userprofile%\OpenSSL"
              set PATH=%PATH%;%programfiles%\7-Zip\
              curl -o "nasm.zip" "${{ inputs.nasmurl }}"
              7z e -tzip -o"%programfiles%\nasm" "nasm.zip"
              curl -o "openssl.tar.gz" "${{ inputs.sslrel }}"
              7z x -so "openssl.tar.gz" | 7z x -ttar -si -o"%userprofile%"
              cd "%userprofile%\openssl-${{ inputs.osslver }}"
      - name: Configure MSVC CMD for amd64
        uses: ilammy/msvc-dev-cmd@v1.13.0
        with:
          arch: amd64
      - name: Build OpenSSL
        shell: cmd
        run: |
              set PATH=%PATH%;%programfiles%\7-Zip\;%programfiles%\nasm
              perl Configure VC-WIN64A --prefix="%userprofile%\OpenSSL"
              nmake
              nmake test
              nmake install
      # 7z a -tzip -mx9 -o"%userprofile%" "openssl-amd64.zip" "%programfiles%\OpenSSL\"
      - name: Upload OpenSSL
        uses: actions/upload-artifact@v4
        with:
          name: opensslforwin
          path: ${{ steps.osslout.outputs.sslp }}
          compression-level: 9
          include-hidden-files: true
